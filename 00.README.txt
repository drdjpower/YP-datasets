CODE FOR CALCULATIONS IN CELTIC SEA STUDY  (RL: 05.10.25)

The calculations use data from two surveys in the Celtic Seas:
1. Beam trawl surveys
2. Otter trawl surveys

The calculations are done in 3 steps in the following order:

1  Core calculations: These generate the basic estimates for species densities, fishing
   mortality rates, yields and production rates.  The R code in directories 50, 51, 52,
   53, 54, 57 must be run in sequence.
   
2  Bootstrapping:  The R code in this directory computes confidence intervals of measures 
   estimated.  It does this by drawing stratified random samples of hauls, and taking the 
   species-level measures for these hauls.
   
3  Plots: figures based on the calculations, as used in the paper.

Note that the paths to all data files are set locally.  Users need to adjust them accordingly
in each line containing the characters 'load(' .
--------------------------------------------------------------------------------


STEP 1: CORE CALCULATIONS
-------------------------

Code for the core calculations is in dir: 01 calculations

This directory contains the survey data, and a sequence of subdirectories 50,51,52,53,54,57, 
each containing a block of R code.  The code should be run in the numbered order.

01 beam_trawl_surveys: R data file with the beam-trawl survey data used in this study (BTS)
   Source CEFAS

02 otter_trawl_surveys: R data file with the otter-trawl survey data used in this study.
   Source CEFAS: comes from the International Bottom Trawl Survey (IBTS)
   
50 all_surveys_VII: Puts together the BTS and IBTS survey data; filters the data down to ICES
   subarea 7bcefghjk, time period 2012 to 2016, fishlengths >= 10 cm; checks nomenclature

51 all_surveys_VII_SADs: Puts in place species groups and catchabilities for the survey data; 
   this is to allow transformation from survey catch back to abundance in the sea.  Filters 
   fishlengths >= 20 cm to provide a data set for further work.  Generates a species abundance 
   distribution (SAD) for the fish assemblage.

52 STECF_fishing_effort: Takes EU STECF effort data to get commercial fishing effort by mobile
   gear, and calculates effort as swept-area ratio for mobile gears.  These efforts are indexed 
   by ICES rectangle, year, and type of commercial fishing gear.

53 F_from_STECF: Gets catchabilities of the commercial gear by species group, joins them with
   the EU STECF effort data, and takes their product to generate fishing mortality rates by 
   species, rectangle, year and fishlength.  With this information, a fishing mortality rate 
   is assigned to each row of the BTS and IBTS survey data.
   
54 results_on_F_Y: Calculates summary statistics (mean and median) for fishing mortality rates
   at the level of species from the row data in the surveys.  Combining the estimates of
   fishing mortality and biomass in each row of the survey data, the rate of loss of biomass 
   by fishing (yield) is estimated at the species level.

57 P_and_Y:  Gets a randomised, vonB growth rate for each captured fish in the survey data, 
   corresponding to the fish length at the time of capture.  Generates a survivorship to this 
   length, to weight the growth rate.  The contribution each row makes to production of
   biomass at the length of capture is then the weighted growth rate.  This is summed over 
   fish within species, to get the production rate, i.e. the rate at which species generate 
   biomass.
--------------------------------------------------------------------------------


STEP 2: BOOTSTRAPPING

Code for bootstrapping is in dir: 01 calculations/bootstrap

   Bootstrapping does no new calculations at the level of individual fish on: numbers,B,F,Y,P.  
   That work was all done in step 1.  Bootstrapping simply rebuilds the survey data with 
   stratified random samples of hauls.  It uses two versions of the survey data:
      allsurveys_Q20FY.Rdata      survey data          dir: 54 results_on_F_Y
      allsurveys_Q20FYP.Rdata     survey data with P   dir: 57 P_and_Y

   WARNING: Running this code for 1000 bootstraps may take a while (10 hours?)
 --------------------------------------------------------------------------------
 
 
 STEP 3: GRAPH PLOTTING
 
 Code for text figures on Celtic Sea survey data is in dir: 02 figures
 
 Code for Appendix figure on growth trajectories is in dir: 57 P_and_Y. The figure is 
 copied and pasted into dir: 02 figures.
 
 
 

